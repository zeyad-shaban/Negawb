{% extends 'categories/base.html' %}
{% load static %}
{% block title %} A social media platform to avoid distraction | Dfreemedia{% endblock title %}

{% block description %}We divide posts according to their topic to help you stay focused and receive relevant topics
only, giving users the power to hide unwanted topics{% endblock description %}

{% block content %}
<ul class="list-group list-group-horizontal">
    <li class="list-group-item active homepageView">Posts</li>
    <li class="list-group-item homepageView">Topics</li>

    {% if not user.hide_followed_posts %}
    <li class="list-group-item homepageView">Followed</li>
    {% endif %}
</ul>
<!-- categories -->
<div class="homepageItem" id="categoryContainer" data-url="{% url 'userpage:get_user_by_id' %}" data-currUser="{{user}}"
    data-likeUrl="{% url 'comments:post_like_dislike' 1%}">
    <h1 class="text-center mb-3">Post topics</h1>
    <p>We divide posts into topics to prevent getting distracted between unwanted topics and focus on wanted once only.
        You can hide unwanted topics of posts from the Distraction Free menu in your <a
            href="{% url 'userpage:home' %}">profile</a>.
    </p>
    <div class="container-fluid">
        <div class="row">
            {% for category in categories %}
            <div class="col-md-4">
                <a href="{% url 'categories:view_category' category.id %}" class="text-white btn">
                    <div class="card text-white bg-{{category.display}} mb-3">
                        <div class="card-body">
                            <h5 class="card-title">{{ category.title }}</h5>
                            <p class="card-text">{{category.description}}.</p>
                            <a href="{% url 'categories:view_category' category.id %}" class="btn btn-dark">Visit</a>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Homepage posts -->
<div class="homepageItem" id="postsContainer">
    <div class="text-center container">
        {% if not user.is_authenticated or not user.homepage_posts %}
        <h1 class="text-center">All topics</h1>
        <small>You can change the default homepage posts from the Distraction Free menu in you <a
                href="{% url 'userpage:home' %}">profile</a></small>
        {% else %}
        <h1 class="text-center">{{ user.homepage_posts.title }}</h1>
        {% endif %}
    </div>
    <form method="POST" class="mb-4" enctype="multipart/form-data" action="{% url 'comments:create_post' 1 %}">
        <div class="ml-2">
            {% csrf_token %}
            <div class="form-group col-md-5">
                <label for="id_post_description">Description</label>
                <textarea type="text" name="description" id="id_post_description" class="form-control"></textarea>
            </div>
            <div class="form-group">
                <p class="form-text text-muted"><label for="id_post_image">Image</label>
                    <input type="file" name="image" accept="image/*" id="id_image"></p>
            </div>
            <div class="form-group">
                <p class="form-text text-muted"><label for="id_post_image">Or Video</label>
                    <input type="file" name="post_file" accept="video/*" id="id_post_file"></p>
            </div>
            <label for="id_category">Topic</label>
            <select name="id_category" id="id_category">
                <option value="test">All</option>
                {% for acategory in all_categories %}
                {% if user.homepage_posts and user.homepage_posts.id == acategory.id  %}
                <option value="{{ acategory.id }}" selected="selected">{{ acategory.title }}</option>
                {% else %}
                <option value="{{ acategory.id }}">{{ acategory.title }}</option>
                {% endif %}
                {% endfor %}
            </select>

            <small class="form-text text-muted">You don't have to specify image or video, but if you do then only one of
                them</small>

            <input type="submit" value="Post" class="btn btn-lg mt-2 btn-success" id="addPostButton">
        </div>
    </form>
    {% for post in homepage_posts %}
    <a href="{% url 'people:people' post.user.id %}">
        {% if post.user.who_see_avatar == 'everyone' %}
        <img src="{{post.user.avatar.url}}" alt="{{ post.user.username }}" width="64" height="64"
            class="mr-3 float-left rounded-circle {% if post.user.id <= 1000 %}oldUser{% endif %}" loading="lazy">
        {% elif post.user.who_see_avatar == 'friends' and user in post.user.friends.all %}
        <img src="{{post.user.avatar.url}}" alt="{{ post.user.username }}" width="64" height="64"
            class="mr-3 float-left rounded-circle {% if post.user.id <= 1000 %}oldUser{% endif %}" loading="lazy">
        {% elif post.user == user %}
        <img src="{{post.user.avatar.url}}" alt="{{ post.user.username }}" width="64" height="64"
            class="mr-3 float-left rounded-circle {% if post.user.id <= 1000 %}oldUser{% endif %}" loading="lazy">
        {% else %}
        <img src="/media/profile_images/DefaultUserImage.jpg" alt="{{ post.user.username }}" width="64" height="64"
            class="mr-3 float-left rounded-circle {% if post.user.id <= 1000 %}oldUser{% endif %}" loading="lazy">
        {% endif %}
        <span>{{post.user.username}}</span>
    </a>
    <div class="mb-3">
        <div class="card-body">
            {% if post.description %}
            <blockquote class="blockquote mb-0">
                <p class="text-break" style="white-space: pre-wrap">{{post.description|truncatechars:450}} {% if post.description|length > 450%}<a
                        href="{% url 'comments:view_post' post.id %}">Read
                        More</a>{% endif %}</p>
            </blockquote>
            {% endif %}
            <small class="form-text text-muted">{{post.views.count}} Views ♦︎ {{ post.post_date|timesince }} ago -{% if post.category %} {{ post.category.title }} {% else %} All {% endif %} Topic</small>

            {% if post.image %}
            <img src="{{ post.image.url }}" alt="{{ post.user.username }}" height="250" width="40%">
            {% elif post.post_file %}
            <video width="100%" controls class="col-md-10 col-lg-8" preload="none">
                <source src="{{ post.post_file.url }}" type="video/mp4">
                <source src="{{ post.post_file.url }}" type="video/ogg">
                Your browser does not support the video tag.
            </video>
            {% endif %}
        </div>
    </div>
    <span class="row justify-content-center">
        <span><a href="{% url 'comments:view_post' post.id %}" style="text-decoration: none; color:black;"><i
                    class="far fa-comment-dots" style="font-size:36px;"></i></a></span>
        <!-- Like -->
        <form method="GET" class="form-inline likeForm" action="{% url 'comments:post_like_dislike' post.id %}"
            data-pk="{{post.id}}">
            <button type="submit" name="submit" value="like" title="Like" class="btn btn-link">
                <i class="fa fa-thumbs-o-up" aria-hidden="true" style="font-size:36px"></i>
            </button>
        </form>
        <span class="m-3" id="id_likes{{post.id}}">
            {% if user in post.likes.all %}
            <p style="color:#065FD4;">{{post.likes.count}}</p>
            {% else %}
            <p style="color:black;">{{post.likes.count}}</p>
            {% endif %}
        </span>
        <!-- Dislike -->
        <form action="{% url 'comments:post_like_dislike' post.id %}" method="GET" class="form-inline dislikeForm"
            data-pk="{{ post.id }}">
            <button type="submit" name="submit" value="dislike" title="Dislike" class="btn">
                <i class="fa fa-thumbs-o-down" aria-hidden="true" style="font-size:36px"></i>
            </button>
        </form>
        <span class="m-3" id="id_dislikes{{post.id}}">
            {% if user in post.dislikes.all %}
            <p style="color:#065FD4;">{{post.dislikes.count}}</p>
            {% else %}
            <p style="color:black;">{{post.dislikes.count}}</p>
            {% endif %}
        </span>
    </span>
    {% endfor %}
</div>

{% if not user.hide_followed_posts %}
<!-- FOLLOWED POSTS -->
<div id="followedPosts" class="homepageItem">
    <!-- Followed users -->

    {% if followed.count <= 0 or not user.is_authenticated %}
    <h1>You are not following anyone</h1>
    {% else %}

    <ul class="list-unstyled col-lg-1 col-md-2 mr-1 float-left">
        {% for followed in followed %}
        <li class="media">
            <a href="{% url 'people:people' followed.id %}" class="btn">
                {% if followed.who_see_avatar == 'everyone' %}
                <img src="{{followed.avatar.url}}" alt="User Image" width="64" height="64"
                    class="mr-3 rounded-circle {% if followed.id <= 1000 %}oldUser{% endif %}">
                {% elif followed.who_see_avatar == 'friends' and user in followed.friends.all %}
                <img src="{{followed.avatar.url}}" alt="User Image" width="64" height="64"
                    class="mr-3 rounded-circle {% if followed.id <= 1000 %}oldUser{% endif %}">
                {% elif followed == user %}
                <img src="{{followed.avatar.url}}" alt="User Image" width="64" height="64"
                    class="mr-3 rounded-circle {% if followed.id <= 1000 %}oldUser{% endif %}">
                {% else %}
                <img src="/media/profile_images/DefaultUserImage.jpg" alt="User Image" width="64" height="64"
                    class="mr-3 rounded-circle {% if followed.id <= 1000 %}oldUser{% endif %}">
                {% endif %}
                <div class="media-body">
                    <h5 class="mt-0 mb-1 float-right">{{ followed.username }}</h5>
                </div>
            </a>
        </li>
        {% endfor %}
    </ul>
    <!-- Posts -->
    <div class="col-lg-10 col-md-9 float-right" id="followedPostsContainer">
        {% for post in followed_posts %}
        <a href="{% url 'people:people' post.user.id %}">
            {% if post.user.who_see_avatar == 'everyone' %}
            <img src="{{post.user.avatar.url}}" alt="{{ post.user.username }}" width="64" height="64"
                class="mr-3 rounded-circle float-left" loading="lazy">
            {% elif post.user.who_see_avatar == 'friends' and user in post.user.friends.all %}
            <img src="{{post.user.avatar.url}}" alt="{{ post.user.username }}" width="64" height="64"
                class="mr-3 rounded-circle float-left" loading="lazy">
            {% elif post.user == user %}
            <img src="{{post.user.avatar.url}}" alt="{{ post.user.username }}" width="64" height="64"
                class="mr-3 rounded-circle float-left" loading="lazy">
            {% else %}
            <img src="/media/profile_images/DefaultUserImage.jpg" alt="{{ post.user.username }}" width="64" height="64"
                class="mr-3 rounded-circle float-left" loading="lazy">
            {% endif %}
            <span>{{post.user.username}}</span>
        </a>
        <div class="mb-3">
            <div class="card-body">
                {% if post.description %}
                <blockquote class="blockquote mb-0">
                    <p class="text-break" style="white-space: pre-wrap;">{{post.description|truncatechars:450}}
                        {% if post.description|length > 450%}<a href="{% url 'comments:view_post' post.id %}">Read
                            More</a>{% endif %}</p>
                </blockquote>
                {% endif %}
                <small class="form-text text-muted">{{post.views.count}} ♦︎ {{ post.post_date|timesince }} ago -{% if post.category %} {{ post.category.title }} {% else %} All {% endif %} Topic</small>

                {% if post.image %}
                <img src="{{ post.image.url }}" alt="{{ post.user.username }}" height="250" width="40%">
                {% elif post.post_file %}
                <video width="100%" controls class="col-md-10 col-lg-8" preload="none">
                    <source src="{{ post.post_file.url }}" type="video/mp4">
                    <source src="{{ post.post_file.url }}" type="video/ogg">
                    Your browser does not support the video tag.
                </video>
                {% endif %}
            </div>
        </div>
        <span class="row justify-content-center">
            <span><a href="{% url 'comments:view_post' post.id %}" style="text-decoration: none; color:black;"><i
                        class="far fa-comment-dots" style="font-size:36px;"></i></a></span>
            <!-- Like -->
            <form method="GET" class="form-inline likeForm" action="{% url 'comments:post_like_dislike' post.id %}"
                data-pk="{{post.id}}">
                <button type="submit" name="submit" value="like" title="Like" class="btn btn-link">
                    <i class="fa fa-thumbs-o-up" aria-hidden="true" style="font-size:36px"></i>
                </button>
            </form>
            <span class="m-3" id="followed_likes{{post.id}}">
                {% if user in post.likes.all %}
                <p style="color:#065FD4;">{{post.likes.count}}</p>
                {% else %}
                <p style="color:black;">{{post.likes.count}}</p>
                {% endif %}
            </span>
            <!-- Dislike -->
            <form action="{% url 'comments:post_like_dislike' post.id %}" method="GET" class="form-inline dislikeForm"
                data-pk="{{ post.id }}">
                <button type="submit" name="submit" value="dislike" title="Dislike" class="btn">
                    <i class="fa fa-thumbs-o-down" aria-hidden="true" style="font-size:36px"></i>
                </button>
            </form>
            <span class="m-3" id="followed_dislikes{{post.id}}">
                {% if user in post.dislikes.all %}
                <p style="color:#065FD4;">{{post.dislikes.count}}</p>
                {% else %}
                <p style="color:black;">{{post.dislikes.count}}</p>
                {% endif %}
            </span>
        </span>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% else %}
<small class="from-text text-muted">Your Distraction Free settings doesn't allow posts to show in home page</small>
{% endif %}
</div>
<script src="{% static 'categories/index.js' %}"></script>
<link rel="stylesheet" href="{% static 'categories/index.css' %}">
{% endblock content %}