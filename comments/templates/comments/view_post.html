{% extends 'categories/base.html' %}
{% load static %}
{% block title %} {{post.user.username}} {% if post.description %} {{post.description}}{% endif %} | Dfreemedia
{% endblock title %}

{% block description %}
{% if post.description %}
{{post.description}}
{% endif %}
{% endblock description %}

{% block content %}
<!-- <link href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css"> -->
<link rel="stylesheet" href="{% static 'comments/view_post.css' %}">
<script src="{% static 'comments/view_post.js' %}"></script>

<a href="{% url 'people:people' post.user.id %}">
    {% if post.user.who_see_avatar == 'everyone' %}
    <img src="{{post.user.avatar.url}}" alt="{{ post.user.username }}" width="64" height="64"
        class="mr-3 float-left rounded-circle {% if post.user.id <= 1000 %}oldUser{% endif %}" loading="lazy">
    {% elif post.user.who_see_avatar == 'friends' and user in post.user.friends.all %}
    <img src="{{post.user.avatar.url}}" alt="{{ post.user.username }}" width="64" height="64"
        class="mr-3 float-left rounded-circle {% if post.user.id <= 1000 %}oldUser{% endif %}" loading="lazy">
    {% elif post.user == user %}
    <img src="{{post.user.avatar.url}}" alt="{{ post.user.username }}" width="64" height="64"
        class="mr-3 float-left rounded-circle {% if post.user.id <= 1000 %}oldUser{% endif %}" loading="lazy">
    {% else %}
    <img src="/media/profile_images/DefaultUserImage.jpg" alt="{{ post.user.username }}" width="64" height="64"
        class="mr-3 float-left rounded-circle {% if post.user.id <= 1000 %}oldUser{% endif %}" loading="lazy">
    {% endif %}
    <span>{{post.user.username}}</span>
</a>
{% if user == post.user %}
<div class="dropdown">
    <button class="btn mr-2 float-right" type="button" id="dropdownMenuButton" data-toggle="dropdown"
        aria-haspopup="true" aria-expanded="false" style="font-size: 36px;"><i class="fas fa-ellipsis-h"></i></button>
    <div class="dropdown-menu mr-3" aria-labelledby="dropdownMenuButton">
        <!-- <a class="dropdown-item" href="#" id="editPost"><i class="far fa-edit"></i> Edit</a> -->
        <a class="dropdown-item" href="{% url 'comments:delete_post' post.id %}" id="deletePost"><i
                class="fas fa-trash-alt"></i> Delete</a>

    </div>
</div>
{% endif %}
<a href="{% url 'people:people' post.user.id %}">
</a>
<div class="mb-3">
    <div class="card-body">
        {% if post.description %}
        <blockquote class="blockquote mb-0">
            <p class="text-break">{{post.description}}</p>
        </blockquote>
        {% endif %}
        <small class="form-text text-muted">{{post.views.count}} Views ♦︎ {{ post.post_date|timesince }} ago -{% if post.category %} {{ post.category.title }} {% else %} All {% endif %} Topic</small>

        {% if post.image %}
        <img src="{{ post.image.url }}" alt="{{ post.user.username }}" height="w" width="40%">
        {% elif post.post_file %}
        <video width="100%" controls class="col-md-10 col-lg-8" preload="none">
            <source src="{{ post.post_file.url }}" type="video/mp4">
            <source src="{{ post.post_file.url }}" type="video/ogg">
            Your browser does not support the video tag.
        </video>
        {% endif %}
    </div>
</div>
<span class="row justify-content-center">
    <span><a href="{% url 'comments:view_post' post.id %}" style="text-decoration: none; color:black;"><i
                class="far fa-comment-dots" style="font-size:36px;"></i></a></span>
    <!-- Like -->
    <form method="GET" class="form-inline likeForm" action="{% url 'comments:post_like_dislike' post.id %}"
        data-pk="{{post.id}}">
        <button type="submit" name="submit" value="like" title="Like" class="btn btn-link">
            <i class="fa fa-thumbs-o-up" aria-hidden="true" style="font-size:36px"></i>
        </button>
    </form>
    <span class="m-3" id="id_likes{{post.id}}">
        {% if user in post.likes.all %}
        <p style="color:#065FD4;">{{post.likes.count}}</p>
        {% else %}
        <p style="color:black;">{{post.likes.count}}</p>
        {% endif %}
    </span>
    <!-- Dislike -->
    <form action="{% url 'comments:post_like_dislike' post.id %}" method="GET" class="form-inline dislikeForm"
        data-pk="{{ post.id }}">
        <button type="submit" name="submit" value="dislike" title="Dislike" class="btn">
            <i class="fa fa-thumbs-o-down" aria-hidden="true" style="font-size:36px"></i>
        </button>
    </form>
    <span class="m-3" id="id_dislikes{{post.id}}">
        {% if user in post.dislikes.all %}
        <p style="color:#065FD4;">{{post.dislikes.count}}</p>
        {% else %}
        <p style="color:black;">{{post.dislikes.count}}</p>
        {% endif %}
    </span>
</span>
{% if user.hide_comments == False or not user.is_authenticated %}
{{comments.count}} Comment{{comments.count|pluralize}}

{% if not user.is_authenticated %}
<div class="alert alert-danger">please login to write comments</div>
{% else %}
<form method="GET" id="commentForm">
    <div class="form-group">
        <textarea type="text" name="description" class="form-control" placeholder="Add comment for this post"
            id="commentInput"></textarea>
    </div>
    <span class="float-right" id="commentCancelButtons">
        <button class="btn btn-secondary" id="cancelCommentButton">Cancel</button>
        <input class="btn btn-primary" type="submit" value="Comment" id="addComment">
    </span>
</form>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        window.addEventListener('load', function () {
            $('#commentForm').submit(function (event) {
                event.preventDefault();
                $.ajax({
                    url: "{% url 'comments:view_post' post.id %}",
                    method: "get",
                    dataType: 'json',
                    data: {
                        'description': $('#commentInput').val(),
                        'action': 'addComment'
                    },
                    success: function (response) {
                        $('.emojionearea-editor').html('')
                        $.ajax({
                            url: "{% url 'userpage:get_user_by_id' %}",
                            data: {
                                'pk': response.comment.user,
                            },
                            method: 'get',
                            dataType: 'json',
                            async: false,
                            success: function (userResponse) {
                                let user = userResponse.user
                                $('.comment-tabs').prepend(`
                    <li class="media">
                        <a href="/people/${user.id}/">
                            <img src="${user.avatar}" alt="User Image" width="64"
                                height="64" class="media-object img-circle">
                        </a>
                        <div class="media-body">
                            <div class="well well-lg">
                                <h4 class="media-heading reviews">${user.username} </h4>
                                <small class="form-text text-muted float-right">
                                    ${response.comment.comment_date}
                                </small>
                                <p class="media-comment" id="commentDescription${response.comment.id}">
                                    ${response.comment.description}
                                </p>
                    `)
                                $('#commentInput').val('')
                            }
                        })
                    }
                })
            })
        })
    })
</script>
<br>
<hr>
{% endif %}
<div class="comment-tabs">
    {% for comment in comments %}
    <li class="media">
        <a href="{% url 'people:people' comment.user.id %}">
            {% if comment.user.who_see_avatar == 'everyone' %}
            <img src="{{comment.user.avatar.url}}" alt="User Image" width="64" height="64"
                class="media-object img-circle {% if comment.user.id <= 1000 %}oldUser{% endif %}">
            {% elif comment.user.who_see_avatar == 'friends' and user in comment.user.friends.all %}
            <img src="{{comment.user.avatar.url}}" alt="User Image" width="64" height="64"
                class="media-object img-circle {% if comment.user.id <= 1000 %}oldUser{% endif %}">
            {% elif comment.user == user %}
            <img src="{{comment.user.avatar.url}}" alt="User Image" width="64" height="64"
                class="media-object img-circle {% if comment.user.id <= 1000 %}oldUser{% endif %}">
            {% else %}
            <img src="/media/profile_images/DefaultUserImage.jpg" alt="User Image" width="64" height="64"
                class="media-object img-circle {% if comment.user.id <= 1000 %}oldUser{% endif %}">
            {% endif %}
        </a>
        <div class="media-body">
            <div class="well well-lg">
                <small class="form-text text-muted float-right">
                    {{comment.comment_date}}
                </small>
                <h4 class="media-heading reviews">{{comment.user.username}} </h4>
                <p class="media-comment" id="commentDescription{{comment.id}}">
                    {{comment.description|truncatechars:300}}
                    {% if comment.description|length >= 300 %} <a href="#" id="commentReadMore{{comment.id}}">Read
                        More</a>{% endif %}
                </p>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        window.addEventListener('load', function () {
                            $('#commentReadMore{{comment.id}}').click(function (event) {
                                event.preventDefault()
                                $('#commentDescription{{comment.id}}').html(
                                    `{{comment.description}}`)
                            })
                        })
                    })
                </script>
                <a class="btn btn-info btn-circle" href="#" id="addReply{{comment.id}}"><span
                        class="glyphicon glyphicon-share-alt"></span> Reply</a>
                <a class="btn btn-warning btn-circle" data-toggle="collapse" href="#replyOne"
                    id="showReplies{{comment.id}}"><span
                        class="glyphicon glyphicon-comment"></span>{{comment.reply_set.count}}
                    Replies</a>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        window.addEventListener('load', function () {
                            $('#showReplies{{comment.id}}').click(function (event) {
                                event.preventDefault();
                                $('#replyList{{comment.id}}').slideToggle()
                            })
                            $('#replyForm{{comment.id}}').slideToggle()
                            $('#addReply{{comment.id}}').click(function (event) {
                                event.preventDefault();
                                $('#replyForm{{comment.id}}').slideToggle()
                                $('#showReplies{{comment.id}}').click()
                            })
                            $('#cancelCommentReply{{comment.id}}').click(function (event) {
                                event.preventDefault;
                                $('#replyForm{{comment.id}}').toggle();
                                $('#commentReplyInput{{comment.id}}').val('')
                            })
                            $('#replyForm{{comment.id}}').submit(function (event) {
                                event.preventDefault();
                                $.ajax({
                                    url: "{% url 'comments:create_reply' comment.id %}",
                                    data: {
                                        'description': $(
                                                '#commentReplyInput{{comment.id}}')
                                            .val(),
                                    },
                                    dataType: 'json',
                                    success: function (response) {
                                        $.ajax({
                                            url: "{% url 'userpage:get_user_by_id' %}",
                                            data: {
                                                'pk': response.reply.user,
                                            },
                                            method: 'get',
                                            dataType: 'json',
                                            async: false,
                                            success: function (
                                                userResponse) {
                                                let user = userResponse
                                                    .user
                                                $('#replyList{{comment.id}}')
                                                    .prepend(`
                                                    <li class="media media-replied">
                                <a href="/people/${user.id}">
                                    <img src="${user.avatar}" alt="User Image" width="64"
                                        height="64">
                                </a>
                                <div class="media-body">
                                    <div class="well well-lg">
                                        <h4 class="media-heading reviews"><span
                                                class="glyphicon glyphicon-share-alt"></span> ${user.username}
                                        </h4>
                                        <smal class="form-text text-muted float-right">
                                            ${response.reply.date}
                                        </smal>
                                        <p class="media-comment">
                                            ${response.reply.description}
                                        </p>
                                    </div>
                                </div>
                            </li>
                                                    `)
                                                $('#commentReplyInput{{comment.id}}')
                                                    .val('')
                                            }
                                        })
                                    }
                                })
                            })
                        })
                    })
                </script>
            </div>
        </div>
    </li>
    {% if user.is_authenticated %}
    <form action="" method="get" id="replyForm{{comment.id}}" class="col-md-7 col-sm-7">
        <div class="form-group">
            <textarea type="text" name="description" class="form-control" placeholder="Add comment for this post"
                id="commentReplyInput{{comment.id}}"></textarea>
        </div>
        <span class="float-right" id="commentCancelButtons">
            <button class="btn btn-secondary" id="cancelCommentReply{{comment.id}}">Cancel</button>
            <input class="btn btn-primary" type="submit" value="Comment" id="addCommentReply">
        </span>
    </form>
    {% else %}
    <div id="replyForm{{comment.id}}">
        <p class="alert alert-danger">Please login to reply</p>
    </div>
    {% endif %}
    <div class="collapse" id="replyList{{comment.id}}">
        <ul class="media-list">
            {% for reply in comment.reply_set.all %}
            <li class="media media-replied">
                <a href="{% url 'people:people' reply.user.id %}">
                    {% if reply.user.who_see_avatar == 'everyone' %}
                    <img src="{{reply.user.avatar.url}}" alt="User Image" width="64" height="64"
                        class="media-object img-circle {% if reply.user.id <= 1000 %}oldUser{% endif %}">
                    {% elif reply.user.who_see_avatar == 'friends' and user in reply.user.friends.all %}
                    <img src="{{reply.user.avatar.url}}" alt="User Image" width="64" height="64"
                        class="media-object img-circle {% if reply.user.id <= 1000 %}oldUser{% endif %}">
                    {% elif reply.user == user %}
                    <img src="{{reply.user.avatar.url}}" alt="User Image" width="64" height="64"
                        class="media-object img-circle {% if reply.user.id <= 1000 %}oldUser{% endif %}">
                    {% else %}
                    <img src="/media/profile_images/DefaultUserImage.jpg" alt="User Image" width="64" height="64"
                        class="media-object img-circle {% if reply.user.id <= 1000 %}oldUser{% endif %}">
                    {% endif %}
                </a>
                <div class="media-body">
                    <div class="well well-lg">
                        <h4 class="media-heading reviews"><span class="glyphicon glyphicon-share-alt"></span>
                            {{reply.user.username}}
                        </h4>
                        <small class="form-text text-muted float-right">
                            {{reply.date}}
                        </small>
                        <p class="media-comment">
                            {{reply.description}}
                        </p>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
</div>
{% else %}
<small class="form-text text-muted">Your Distraction Free settings doesn't allow comments to show up</small>
{% endif %}
{% endblock content %}