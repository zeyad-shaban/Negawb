{% extends 'categories/base.html' %}
{% load static %}
{% block title %}View Comment {% endblock title %}



{% block content %}
<!-- <link href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css"> -->
<link rel="stylesheet" href="{% static 'comments/view_post.css' %}">
<link rel="stylesheet" href="{% static 'social/emojionearea.min.css' %}">
<script src="{% static 'comments/view_post.js' %}"></script>

{% if post.image %}
<a href="{% url 'people:people' post.user.id %}">
    <img src="{{ post.user.avatar.url }}" alt="{{ post.user.username }}" widht="64" height="64" class="mr-3 float-left">
    <span>{{post.user.username}}</span>
</a>
<div class="mb-3">
    <div class="card-body">
        {% if post.description %}
        <p class="card-text">{{post.description|truncatechars:200}}{% if post.description|length > 200%}<a
                href="{% url 'comments:view_post' post.id %}">Read
                More</a>{% endif %}</p>
        {% endif %}
        <div class="text-center">
            <img src="{{ post.image.url }}" alt="{{ post.user.username }}" class="img-fluid rounded">
        </div>
        <p class="card-text"><small class="form-text text-muted">Published at {{ post.post_date|date:'d M Y' }}</small>
        </p>
    </div>
</div>
<!-- Descriptin only post -->
{% elif post.description and not post.image and not post.post_file %}
<div class="media">
    <a href="{% url 'people:people' post.user.id %}">
        {% if post.user.who_see_avatar == 'everyone' %}
        <img src="{{post.user.avatar.url}}" alt="User Image" width="64" height="64">
        {% elif post.user.who_see_avatar == 'friends' and user in post.user.friends.all %}
        <img src="{{post.user.avatar.url}}" alt="User Image" width="64" height="64">
        {% elif post.user == user %}
        <img src="{{post.user.avatar.url}}" alt="User Image" width="64" height="64">
        {% else %}
        <img src="/media/profile_images/DefaultUserImage.WebP" alt="User Image" width="64" height="64">
        {% endif %}
        <div class="media-body">
            <h5 class="mt-0">{{post.user.username}}</h5>
    </a>
    <br>
    {{post.description}}
</div>
</div>
<!-- File post -->
{% elif post.post_file %}
<a href="{% url 'people:people' post.user.id %}">
    <img src="{{ post.user.avatar.url }}" alt="{{ post.user.username }}" widht="64" height="64" class="mr-3 float-left">
    <span>{{post.user.username}}</span>
</a>
<div class="mb-3">
    <div class="card-body">
        {% if post.description %}
        <p class="card-text">{{post.description|truncatechars:200}}{% if post.description|length > 200%}<a
                href="{% url 'comments:view_post' post.id %}">Read
                More</a>{% endif %}</p>
        {% endif %}
        <video width="400" height="320" controls>
            <source src="{{ post.post_file.url }}" type="video/mp4">
            <source src="{{ post.post_file.url }}" type="video/ogg">
            Your browser does not support the video tag.
        </video>
        <p class="card-text"><small class="form-text text-muted">Published at {{ post.post_date|date:'d M Y' }}</small>
        </p>
    </div>
</div>
{% endif %}
<span class="row justify-content-center">
    <!-- Like -->
    <form method="GET" id="likeForm{{post.id}}" class="form-inline">
        <button type="submit" name="submit" value="like" title="Like" class="btn btn-link">
            <i class="fa fa-thumbs-o-up" aria-hidden="true" style="font-size:36px" id="likeButton{{post.id}}"></i>
        </button>
    </form>
    <span class="m-3" id="id_likes{{post.id}}">
        {% if user in post.likes.all %}
        <p style="color:#065FD4;"><b>{{post.likes.count}}</b></p>
        {% else %}
        <p style="color:black;">{{post.likes.count}}</p>
        {% endif %}
    </span>
    <!-- add like script -->
    <script>
        $(document).ready(function () {

            $('#likeForm{{post.id}}').click((event) => {
                event.preventDefault()
            })
            $('#likeButton{{post.id}}').click(function (event) {
                $.ajax({
                    url: "{% url 'comments:post_like_dislike' post.id %}",
                    data: {
                        'submit': 'like',
                    },
                    method: 'get',
                    dataType: 'json',
                    success: function (data) {
                        let likes = "{{post.likes.count}}";
                        let dislikes = "{{ post.dislikes.count }}"
                        if (data.action == 'undislike_and_like') {
                            dislikes -= 1
                            likes++
                            $('#id_dislikes{{post.id}}').html('<p style="color:black;">' +
                                dislikes + '</p>')
                            $('#id_likes{{post.id}}').html('<p style="color:#065FD4;"><b>' +
                                likes + '</b></p>')
                        } else if (data.action == 'unlike') {
                            likes -= 1
                            $('#id_likes{{post.id}}').html('<p style="color:#black;"' +
                                likes +
                                '</p>')
                        } else {
                            likes++
                            $('#id_likes{{post.id}}').html('<p style="color:#065FD4;"><b>' +
                                likes + '</b></p>')
                        }
                    }
                })
            })

        })
    </script>
    <!-- Dislike -->
    <form action="{% url 'comments:post_like_dislike' post.id %}" method="post" class="form-inline"
        id="dislikeForm{{post.id}}">
        {% csrf_token %}
        <button type="submit" id="dislikeButton{{post.id}}" name="submit" value="dislike" title="Dislike" class="btn">
            <i class="fa fa-thumbs-o-down" aria-hidden="true" style="font-size:36px"></i>
        </button>
    </form>
    <span class="m-3" id="id_dislikes{{post.id}}">
        {% if user in post.dislikes.all %}
        <p style="color:#065FD4;"><b>{{post.dislikes.count}}</b></p>
        {% else %}
        <p style="color:black;">{{post.dislikes.count}}</p>
        {% endif %}
    </span>
    <!-- add like script -->
    <script>
        $(document).ready(function () {

            $('#dislikeForm{{post.id}}').click((event) => {
                event.preventDefault()
            })
            $('#dislikeButton{{post.id}}').click(function (event) {
                $.ajax({
                    url: "{% url 'comments:post_like_dislike' post.id %}",
                    data: {
                        'submit': 'dislike',
                    },
                    dataType: 'json',
                    success: function (data) {
                        let likes = "{{post.likes.count}}";
                        let dislikes = "{{ post.dislikes.count }}"
                        if (data.action == 'unlike_and_dislike') {
                            dislikes++
                            likes -= 1
                            $('#id_dislikes{{post.id}}').html(
                                '<p style="color:#065FD4;"><b>' +
                                dislikes + '</b></p>')
                            $('#id_likes{{post.id}}').html('<p style="color:black;">' +
                                likes + '</p>')
                        } else if (data.action == 'undislike') {
                            dislikes -= 1
                            $('#id_dislikes{{post.id}}').html('<p style="color:#black;"' +
                                dislikes +
                                '</p>')
                        } else {
                            dislikes++
                            $('#id_dislikes{{post.id}}').html(
                                '<p style="color:#065FD4;"><b>' +
                                dislikes + '</b></p>')
                        }
                    }
                })
            })

        })
    </script>
</span>
{% if user.hide_comments == False %}
{{comments.count}} Comment{{comments.count|pluralize}}
<form method="GET" id="commentForm">
    <div class="form-group">
        <textarea type="text" name="description" class="form-control" placeholder="Add comment for this post"
            id="commentInput"></textarea>
    </div>
    <span class="float-right" id="commentCancelButtons">
        <button class="btn btn-secondary" id="cancelCommentButton">Cancel</button>
        <input class="btn btn-primary" type="submit" value="Comment" id="addComment">
        <script>
            $(document).ready(function () {
                $("textarea").emojioneArea({
                    pickerPosition: "bottom"
                });
            })
        </script>
    </span>
</form>
<script>
    $(document).ready(function () {
        $('#commentForm').submit(function (event) {
            event.preventDefault()
        })
        $('#addComment').click(function (event) {
            event.preventDefault();
            $.ajax({
                url: "{% url 'comments:view_post' post.id %}",
                method: "get",
                dataType: 'json',
                data: {
                    'description': $('#commentInput').val(),
                    'action': 'addComment'
                },
                success: function (response) {
                    let userImage
                    if (response.comment.user.who_see_avatar == "everyone") {
                        userImage = "{response.comment.user.avatar.url}"
                    } else {
                        userImage = "/media/profile_images/DefaultUserImage.WebP"
                    }
                    $('#commentsList').prepend(`
                    <li class="media">
                        <a href="/people/${response.comment.user.id}/">
                            <img src="${userImage}" alt="User Image" width="64"
                                height="64" class="media-object img-circle">
                        </a>
                        <div class="media-body">
                            <div class="well well-lg">
                                <h4 class="media-heading reviews">${response.comment.user.username} </h4>
                                <span class="media-date reviews list-inline">
                                    ${response.comment.comment_date}
                                </span>
                                <p class="media-comment" id="commentDescription${response.comment.id}">
                                    ${response.comment.description}
                                </p>
                    `)
                    $('#commentInput').val('')
                }
            })
        })
    })
</script>
<br>
<hr>
<div class="row">
    <div class="comment-tabs">
        <div class="tab-content">
            <div class="tab-pane active" id="comments-logout">
                <ul class="media-list" id="commentsList">
                    {% for comment in comments %}
                    <li class="media">
                        <a href="{% url 'people:people' comment.user.id %}">
                            {% if comment.user.who_see_avatar == 'everyone' %}
                            <img src="{{comment.user.avatar.url}}" alt="User Image" width="64" height="64"
                                class="media-object img-circle">
                            {% elif comment.user.who_see_avatar == 'friends' and user in comment.user.friends.all %}
                            <img src="{{comment.user.avatar.url}}" alt="User Image" width="64" height="64"
                                class="media-object img-circle">
                            {% elif comment.user == user %}
                            <img src="{{comment.user.avatar.url}}" alt="User Image" width="64" height="64"
                                class="media-object img-circle">
                            {% else %}
                            <img src="/media/profile_images/DefaultUserImage.WebP" alt="User Image" width="64"
                                height="64" class="media-object img-circle">
                            {% endif %}
                        </a>
                        <div class="media-body">
                            <div class="well well-lg">
                                <h4 class="media-heading reviews">{{comment.user.username}} </h4>
                                <span class="media-date reviews list-inline">
                                    {{comment.comment_date}}
                                </span>
                                <p class="media-comment" id="commentDescription{{comment.id}}">
                                    {{comment.description|truncatechars:300}}
                                    {% if comment.description|length >= 300 %} <a href="#"
                                        id="commentReadMore{{comment.id}}">Read More</a>{% endif %}
                                </p>
                                <script>
                                    $(document).ready(function () {
                                        $('#commentReadMore{{comment.id}}').click(function (event) {
                                            event.preventDefault()
                                            $('#commentDescription{{comment.id}}').html(
                                                `{{comment.description}}`)
                                        })
                                    })
                                </script>
                                <a class="btn btn-info btn-circle" href="#" id="addReply{{comment.id}}"><span
                                        class="glyphicon glyphicon-share-alt"></span> Reply</a>
                                <a class="btn btn-warning btn-circle" data-toggle="collapse" href="#replyOne"
                                    id="showReplies{{comment.id}}"><span
                                        class="glyphicon glyphicon-comment"></span>{{comment.reply_set.count}}
                                    Replies</a>
                                <script>
                                    $(document).ready(function () {
                                        $('#showReplies{{comment.id}}').click(function (event) {
                                            event.preventDefault();
                                            $('#replyList{{comment.id}}').slideToggle()
                                        })
                                        $('#replyForm{{comment.id}}').slideToggle()
                                        $('#addReply{{comment.id}}').click(function (event) {
                                            event.preventDefault();
                                            $('#replyForm{{comment.id}}').slideToggle()
                                        })
                                        $('#cancelCommentReply{{comment.id}}').click(function (event) {
                                            event.preventDefault;
                                            $('#replyForm{{comment.id}}').toggle();
                                            $('#commentReplyInput{{comment.id}}').val('')
                                        })
                                        $('#replyForm{{comment.id}}').submit(function (event) {
                                            event.preventDefault();
                                            $.ajax({
                                                url: "{% url 'comments:create_reply' comment.id %}",
                                                data: {
                                                    'description': $(
                                                            '#commentReplyInput{{comment.id}}')
                                                        .val(),
                                                },
                                                dataType: 'json',
                                                success: function (response) {
                                                    let avatarImage
                                                    if (response.reply.user
                                                        .who_see_avatar == 'everyone') {
                                                        avatarImage = response.reply.user
                                                            .avatar.url
                                                    } else if (response.reply.user ==
                                                        "{{user}}") {
                                                        avatarImage = response.reply.user
                                                            .avatar.url
                                                    } else {
                                                        avatarImage =
                                                            "/media/profile_images/DefaultUserImage.WebP"
                                                    }
                                                    $('#replyList{{comment.id}}').prepend(`
                                                    <li class="media media-replied">
                                <a href="/people/${response.reply.id}">
                                    <img src="${avatarImage}" alt="User Image" width="64"
                                        height="64">
                                </a>
                                <div class="media-body">
                                    <div class="well well-lg">
                                        <h4 class="media-heading reviews"><span
                                                class="glyphicon glyphicon-share-alt"></span> ${response.reply.user.username}
                                        </h4>
                                        <span class="media-date reviews list-inline">
                                            ${response.reply.date}
                                        </span>
                                        <p class="media-comment">
                                            ${response.reply.description}
                                        </p>
                                    </div>
                                </div>
                            </li>
                                                    `)
                                                    $('#commentReplyInput{{comment.id}}')
                                                        .val('')
                                                }
                                            })
                                        })
                                    })
                                </script>
                            </div>
                        </div>
                    </li>
                    <form action="" method="get" id="replyForm{{comment.id}}">
                        <div class="form-group">
                            <textarea type="text" name="description" class="form-control"
                                placeholder="Add comment for this post" id="commentReplyInput{{comment.id}}"></textarea>
                        </div>
                        <span class="float-right" id="commentCancelButtons">
                            <button class="btn btn-secondary" id="cancelCommentReply{{comment.id}}">Cancel</button>
                            <input class="btn btn-primary" type="submit" value="Comment" id="addCommentReply">
                        </span>
                    </form>
                    <div class="collapse" id="replyList{{comment.id}}">
                        <ul class="media-list">
                            {% for reply in comment.reply_set.all %}
                            <li class="media media-replied">
                                <a href="{% url 'people:people' reply.user.id %}">
                                    {% if reply.user.who_see_avatar == 'everyone' %}
                                    <img src="{{reply.user.avatar.url}}" alt="User Image" width="64" height="64"
                                        class="media-object img-circle">
                                    {% elif reply.user.who_see_avatar == 'friends' and user in reply.user.friends.all %}
                                    <img src="{{reply.user.avatar.url}}" alt="User Image" width="64" height="64"
                                        class="media-object img-circle">
                                    {% elif reply.user == user %}
                                    <img src="{{reply.user.avatar.url}}" alt="User Image" width="64" height="64"
                                        class="media-object img-circle">
                                    {% else %}
                                    <img src="/media/profile_images/DefaultUserImage.WebP" alt="User Image" width="64"
                                        height="64">
                                    {% endif %}
                                </a>
                                <div class="media-body">
                                    <div class="well well-lg">
                                        <h4 class="media-heading reviews"><span
                                                class="glyphicon glyphicon-share-alt"></span> {{reply.user.username}}
                                        </h4>
                                        <span class="media-date reviews list-inline">
                                            {{reply.date}}
                                        </span>
                                        <p class="media-comment">
                                            {{reply.description}}
                                        </p>
                                    </div>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% else %}
    <small class="form-text text-muted">Your Distraction Free settings doesn't allow comments to show up😍</small>
    {% endif %}
<script src="{% static 'social/emojionearea.min.js' %}"></script>
    {% endblock content %}