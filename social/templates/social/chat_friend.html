{% load static %}

<head>
    <script async src="https://kit.fontawesome.com/78f2495e06.js" crossorigin="anonymous"></script>
    <script async src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel='shortcut icon' href="{% static 'categories/favicon.jpg' %}" type="image/WebP">
    <meta name="description" content="{% block description %} {% endblock description %}">
    <meta name="author" content="Zeyad Shaban">
    <meta charset=" UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <link rel="stylesheet" href="{% static 'social/chat.css' %}">
    <div class="menu">
        <div class="back" id="back"><i class="fa fa-chevron-left"></i>
            {% if friend.who_see_avatar == 'everyone' %}
            <img src="{{friend.avatar.url}}" alt="User Image" width="64" height="64" id="friendAvatar">
            {% elif friend.who_see_avatar == 'friends' and user in friend.friends.all %}
            <img src="{{friend.avatar.url}}" alt="User Image" width="64" height="64" id="friendAvatar">
            {% elif friend == user %}
            <img src="{{friend.avatar.url}}" alt="User Image" width="64" height="64" id="friendAvatar">
            {% else %}
            <img src="/media/profile_images/DefaultUserImage.WebP" alt="User Image" width="64" height="64"
                id="friendAvatar">
            {% endif %}
        </div>
        <div class="name">{{ friend.username }}</div>
        <div class="last">Bio: {{ friend.bio }} -Phone: {{ friend.phone }} -Email: {{ friend.email }} </div>
    </div>
    <ol class="chat">
        <audio id="notificationSound">
            <source src="{% static 'social/notificationsound.wav' %}" type="audio/wav">
            <source src="{% static 'social/notificationsound.wav' %}" type="audio/mp3">
            <source src="{% static 'social/notificationsound.wav' %}" type="audio/ogg">
            <source src="{% static 'social/notificationsound.wav' %}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>

        {% for message in chat_messages %}
        <li class="{% if message.message_sender == friend %}other {% else %}self{% endif %} message"
            data-pk="{{message.id}}">
            <div class="avatar">
                {% if message.message_sender.who_see_avatar == 'everyone' %}
                <img src="{{message.message_sender.avatar.url}}" alt="User Image" width="64" height="64">
                {% elif message.message_sender.who_see_avatar == 'friends' and user in message.message_sender.friends.all %}
                <img src="{{message.message_sender.avatar.url}}" alt="User Image" width="64" height="64">
                {% elif message.message_sender == user %}
                <img src="{{message.message_sender.avatar.url}}" alt="User Image" width="64" height="64">
                {% else %}
                <img src="/media/profile_images/DefaultUserImage.WebP" alt="User Image" width="64" height="64">
                {% endif %}
            </div>
            <div class="msg">
                <p>{{ message.message }}</p>
                <time>{{ message.date|timesince }} ago</time>
            </div>
        </li>
        {% endfor %}

    </ol>
    <form action="{% url 'social:send_friend_message' friend.id %}" method="get" id="sendForm">
        <input class="textarea" id="messageInput" type="text" name="message" placeholder="Type here!" />
        <div class="emojis">
            <input type="checkbox" name="is_important" id="is_important">
        </div>
        <div id="send"><i class="far fa-paper-plane"
                style="font-size:30px; color:white;"></i></div>
    </form>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            window.addEventListener('load', function () {
                window.scrollTo(0, document.body.scrollHeight)
                // Go back
                $('#back').click(function (e) {
                    e.preventDefault();
                    window.history.back();
                })
                let page = 1
                // Top scroll
                function topScroll() {
                    if (window.top == window.self) {
                        $.ajax({
                            url: "{% url 'social:chat_friend' friend.id %}",
                            data: {
                                "page": page,
                            },
                            method: 'get',
                            dataType: 'json',
                            success: function (response) {
                                let sender = "self"
                                let senderAvatar = "{{ user.avatar.url }}"
                                chat_messages = JSON.parse(response.chat_messages).reverse()
                                if (chat_messages.length > 0) {
                                    page++
                                    for (message of chat_messages) {
                                        let dateToString = d =>
                                            `${d.getFullYear()}-${('00' + (d.getMonth() + 1)).slice(-2)}-${('00' + d.getDate()).slice(-2)}`
                                        let messageDate = new Date(Date.parse(message.fields
                                            .date))
                                        let date = dateToString(messageDate)
                                        if (message.fields.message_sender ==
                                            "{{ friend.id }}") {
                                            sender = "other"
                                            senderAvatar = $('#friendAvatar').attr('src')
                                        }
                                        $('.chat').prepend(`
                                    <li class="${sender} message" data-pk="${message.pk}">
                    <div class="avatar">
                        <img src="${senderAvatar}" alt="User Image" width="64" height="64">
                    </div>
                    <div class="msg">
                        <p>${message.fields.message}</p>
                        <time>${date}</time>
                    </div>
                </li>
                                    `)
                                    }
                                }
                            }
                        })
                    }
                }
                topScroll();
                window.addEventListener('scroll', () => topScroll())
                // Send
                $('#send').click(function(e){
                    e.preventDefault();
                    $('#sendForm').submit();
                })
                $('#sendForm').submit(function (e) {
                    e.preventDefault();
                    let newLastMessageId = ''
                    try {
                        let messages = document.getElementsByClassName('message')
                        newLastMessageId = parseInt(messages[messages.length - 1]
                            .getAttribute(
                                'data-pk')) + 1
                    } catch {
                        newLastMessageId = 1
                    }
                    let messageInput = $('#messageInput').val()
                    let is_important = "False"
                    if ($('#is_important').is(':checked')) {
                        is_important = "True"
                    }
                    if (!messageInput == '') {
                        $('.chat').append(`
                        <li class="self message" data-pk="${newLastMessageId}">
                    <div class="avatar">
                        <img src="{{ user.avatar.url }}" alt="User Image" width="64" height="64">
                    </div>
                    <div class="msg">
                        <p>${messageInput}</p>
                        <time>Now</time>
                    </div>
                </li>
                        `)
                        $('#messageInput').val('')
                        document.getElementById('notificationSound').play()
                        window.scrollTo(0, document.body.scrollHeight);
                        $.ajax({
                            url: $('#sendForm').attr('action'),
                            data: {
                                'message': messageInput,
                                'is_important': is_important,
                            },
                            method: 'get',
                            dataType: 'json',
                            success: function (response) {}
                        })
                    }
                })
                // Load new messages
                // Todo use webSockets
                setInterval(() => {
                    let lastMessageId = ''
                    try {
                        let messages = document.getElementsByClassName('message')
                        lastMessageId = messages[messages.length - 1].getAttribute(
                            'data-pk')
                    } catch (error) {
                        lastMessageId = 0
                    }
                    $.ajax({
                        url: "{% url 'social:chat_friend' friend.id %}",
                        data: {
                            'action': 'load_new_messages',
                            'last_message_id': lastMessageId,
                        },
                        method: 'get',
                        async: false,
                        dataType: 'json',
                        success: function (response) {
                            chat_messages = JSON.parse(response.chat_messages)
                            if (response.chat_messages.length > 0) {
                                let newLastMessageId = ''
                                for (message of chat_messages) {
                                    newLastMessageId = message.pk
                                    $('.chat').append(`
                        <li class="other message" data-pk="${newLastMessageId}">
                    <div class="avatar">
                        <img src="${$('#friendAvatar').attr('src')}" alt="User Image" width="64" height="64">
                    </div>
                    <div class="msg">
                        <p>${message.fields.message}</p>
                        <time>Now</time>
                    </div>
                </li>
                        `)
                                    document.querySelector('#notificationSound')
                                        .play();
                                }
                            }
                        }
                    })
                }, 3300);
            })
        })
    </script>
</body>