{% load static %}

<head>
    <script async src="https://kit.fontawesome.com/78f2495e06.js" crossorigin="anonymous"></script>
    <script async src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel='shortcut icon' href="{% static 'categories/favicon.jpg' %}" type="image/WebP">
    <meta name="description" content="{% block description %} {% endblock description %}">
    <meta name="author" content="Zeyad Shaban">
    <meta charset=" UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <link rel="stylesheet" href="{% static 'social/chat.css' %}">
    <div class="menu">
        <div class="back" id="back"><i class="fa fa-chevron-left"></i>
            {% if friend.who_see_avatar == 'everyone' %}
            <img src="{{friend.avatar.url}}" alt="User Image" width="64" height="64">
            {% elif friend.who_see_avatar == 'friends' and user in friend.friends.all %}
            <img src="{{friend.avatar.url}}" alt="User Image" width="64" height="64">
            {% elif friend == user %}
            <img src="{{friend.avatar.url}}" alt="User Image" width="64" height="64">
            {% else %}
            <img src="/media/profile_images/DefaultUserImage.WebP" alt="User Image" width="64" height="64">
            {% endif %}
        </div>
        <div class="name">{{ friend.username }}</div>
        <div class="last">Bio: {{ friend.bio }} -Phone: {{ friend.phone }} -Email: {{ friend.email }} </div>
    </div>
    <ol class="chat">
        <audio id="notificationSound">
            <source src="{% static 'social/notificationsound.wav' %}" type="audio/wav">
            <source src="{% static 'social/notificationsound.wav' %}" type="audio/mp3">
            <source src="{% static 'social/notificationsound.wav' %}" type="audio/ogg">
            <source src="{% static 'social/notificationsound.wav' %}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>

        {% for message in chat_messages %}
        <li class="{% if message.message_sender == friend %}other {% else %}self{% endif %}">
            <div class="avatar">
                {% if message.message_sender.who_see_avatar == 'everyone' %}
                <img src="{{message.message_sender.avatar.url}}" alt="User Image" width="64" height="64">
                {% elif message.message_sender.who_see_avatar == 'friends' and user in message.message_sender.friends.all %}
                <img src="{{message.message_sender.avatar.url}}" alt="User Image" width="64" height="64">
                {% elif message.message_sender == user %}
                <img src="{{message.message_sender.avatar.url}}" alt="User Image" width="64" height="64">
                {% else %}
                <img src="/media/profile_images/DefaultUserImage.WebP" alt="User Image" width="64" height="64">
                {% endif %}
            </div>
            <div class="msg">
                <p>{{ message.message }}</p>
                <time>{{ message.date|timesince }} ago</time>
            </div>
        </li>
        {% endfor %}

    </ol>
    <form action="{% url 'social:send_message' friend.id %}" method="get" id="sendForm">
        <input class="textarea" id="messageInput" type="text" name="message" placeholder="Type here!" />
        <div class="emojis">
            <input type="checkbox" name="is_important" id="is_important">
        </div>
        <div id="send" data-url="{% url 'social:send_message' friend.id %}"><i class="far fa-paper-plane"
                style="font-size:30px; color:white;"></i></div>
    </form>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            window.addEventListener('load', function () {
                // Send
                $('#send').click(function (e) {
                    e.preventDefault();
                    let messageInput = $('#messageInput').val()
                    let is_important = "False"
                    if ($('#is_important').is(':checked')) {
                        is_important = "True"
                    }
                    if (!messageInput == '') {
                        $('.chat').append(`
                        <li class="self">
                    <div class="avatar">
                        <img src="{{ user.avatar.url }}" alt="User Image" width="64" height="64">
                    </div>
                    <div class="msg">
                        <p>${messageInput}</p>
                        <time>Now</time>
                    </div>
                </li>
                        `)
                        document.getElementById('notificationSound').play()
                        $.ajax({
                            url: $('#send').attr('data-url'),
                            data: {
                                'action': 'friend',
                                'message': messageInput,
                                'is_important': is_important,
                            },
                            method: 'get',
                            dataType: 'json',
                            success: function (response) {
                                console.log('Success')
                            }
                        })
                    }
                })
            })
        })
    </script>

</body>