{% load static %}
<!DOCTYPE html>
<html>

<head>
    <link rel='shortcut icon' href="{% static 'categories/favicon.WebP' %}" type="image/WebP">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <!-- <script
        src='//production-assets.codepen.io/assets/editor/live/console_runner-079c09a0e3b9ff743e39ee2d5637b9216b3545af0de366d4b9aad9dc87e26bfd.js'>
    </script>
    <script
        src='//production-assets.codepen.io/assets/editor/live/events_runner-73716630c22bbc8cff4bd0f07b135f00a0bdc5d14629260c3ec49e5606f98fdd.js'>
    </script>
    <script
        src='//production-assets.codepen.io/assets/editor/live/css_live_reload_init-2c0dc5167d60a5af3ee189d570b1835129687ea2a61bee3513dee3a50c115a77.js'>
    </script> -->
    <meta charset='UTF-8'>
    <meta name="robots" content="noindex">
    <link rel="canonical" href="https://codepen.io/emilcarlsson/pen/ZOQZaV?limit=all&page=74&q=contact+" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700,300' rel='stylesheet'
        type='text/css'>

    <script src="https://use.typekit.net/hoy3lrg.js"></script>
    <script>
        try {
            Typekit.load({
                async: true
            });
        } catch (e) {}
    </script>
    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css'>
    <link rel='stylesheet prefetch'
        href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css'>
    <link rel="stylesheet" href="{% static 'userpage/friends.css' %}">
</head>

<body>
    <div id="frame">
        <div id="sidepanel">
            <div id="profile">
                <div class="wrap">
                    <a href="{% url 'userpage:home' %}">
                        <img src="{{ user.avatar.url }}" class="online" alt="" />
                    </a>
                    <p>{{ user.username }}</p>
                </div>
            </div>
            <div id="search">
                <label for=""><i class="fa fa-search" aria-hidden="true"></i></label>
                <input type="text" placeholder="Search contacts..." />
            </div>
            <div id="contacts">
                <ul>
                    {% for friend in friends %}
                    <li class="contact">
                        <div class="wrap" id="chatFriendButton{{friend.id}}">
                            {% if friend.is_online %}
                            <span class="contact-status online"></span>
                            {% else %}
                            <span class="contact-status offline"></span>
                            {% endif %}
                            {% if friend.who_see_avatar == 'everyone' %}
                            <img src="{{ friend.avatar.url }}" alt="{{ friend.username }}"
                                class="img-fluid rounded-circle d-block mx-auto" height="73" width="73">
                            {% else %}
                            <img src="/media/profile_images/DefaultUserImage.WebP" alt="{{ friend.username }}"
                                class="img-fluid rounded-circle d-block mx-auto" height="73" width="73">
                            {% endif %}
                            <div class="meta">
                                <p class="name">{{ friend.username }}</p>
                                <p class="preview"></p>
                            </div>
                        </div>
                    </li>
                    <!-- LOAD FRIEND CHAT -->
                    <script>
                        $(document).ready(function () {

                            $('#chatFriendButton{{friend.id}}').click(function (e) {
                                $.ajax({
                                    url: "{% url 'social:chat_friend' friend.id %}",
                                    data: {
                                        'friend_id': "{{friend.id}}"
                                    },
                                    dataType: 'json',
                                    success: function (response) {
                                        let friend_image
                                        if (response.friend.who_see_avatar == 'everyone' ||
                                            response.friend.who_see_avatar == 'friends') {
                                            friend_image = response.friend.avatar
                                        } else {
                                            friend_image =
                                                '/media/profile_images/DefaultUserImage.WebP'
                                        }
                                        $('#friendProfile').html(
                                            // ! STATIC URL todo
                                            `<a href="/people/${response.friend.id}/">
                                            <img src="${friend_image}" width="40" height="40"/>
                                            </a>
                                            <p>${response.friend.username}</p>`
                                        )
                                        let outputMessages = ''
                                        let chat_messages = JSON.parse(response
                                            .chat_messages)
                                        console.log()
                                        for (message of chat_messages) {
                                            let messageStyle = "null"
                                            if (message.fields.is_important) {
                                                messageStyle = 'style="background: #d10c0c"'
                                            }
                                            if (message.fields.message_sender == response
                                                .friend.id) {
                                                outputMessages += `<li class="replies">
                                    <img src="${friend_image}" alt="" width="22" height="22"/>
                                    <p>${message.fields.message}</p>
                                </li>`
                                            } else {
                                                outputMessages += `
                                            <li class="sent">
                        <img src="{{user.avatar.url}}" alt="" width="22" height="22"/>
                        <p ${messageStyle}>${message.fields.message}</p>
                    </li>
                                            `
                                            }
                                        }
                                        $('#chatMessages').html(outputMessages)
                                    }
                                })
                            });
                        })
                    </script>
                    <!-- SEND MESSAGE -->
                    <script>
                        $(document).ready(function () {

                            $('#sendMessageForm').submit(function (event) {
                                event.preventDefault()
                            })
                            $('#sendMessageButton').click(function () {
                                // TODO FIX BEING UNABLE TO GET USER INPUT
                                // !
                                if ($('#inputMessage').val()) {
                                    $.ajax({
                                        url: "{% url 'social:send_message' %}",
                                        data: {
                                            "pk": "{{friend.id}}",
                                            "message": $("#inputMessage").val()
                                        },
                                        dataType: 'json',
                                        success: function (response) {
                                            console.log('SUCCESS!')
                                        }
                                    })
                                }
                            })
                        })
                    </script>
                    {% endfor %}
                </ul>
            </div>
            <div id="bottom-bar">
                <a href="{% url 'people:all_people' %}"><button id="addcontact"><i class="fa fa-user-plus fa-fw"
                            aria-hidden="true"></i> <span>Find Friends</span></button></a>
                <a href="{% url 'home' %}">
                    <button id="settings"><i class="fa fa-home fa-fw" aria-hidden="true"></i> <span>Home</span></button>
                </a>
            </div>
        </div>
        <div class="content">
            <div class="contact-profile" id="friendProfile">
                <img src="{% static 'categories/favicon.WebP' %}" width="40" height="40" alt="" />
                <p>DFreeMedia</p>
            </div>
            <div class="messages">
                <ul id="chatMessages">
                    <li class="sent">
                        <img src="{{user.avatar.url}}" alt="" width="22" height="22" />
                        <p>How can i unfriend someone here?
                        </p>
                    </li>
                    <li class="replies">
                        <img src="{% static 'categories/favicon.WebP' %}" alt="" width="22" height="22" />
                        <p>Just hold his profile image in the side bar and click unfriend</p>
                    </li>
                </ul>
            </div>
            <div class="message-input">
                <div class="wrap">
                    <form action="" method="get" id="sendMessageForm">
                        <input type="text" placeholder="Write your message..." id="inputMessage" required />
                        <i class="fa fa-paperclip attachment" aria-hidden="true"></i>
                        <button id="sendMessageButton" class="submit"><i class="fa fa-paper-plane"
                                aria-hidden="true"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script
        src='//production-assets.codepen.io/assets/common/stopExecutionOnTimeout-b2a7b3fe212eaa732349046d8416e00a9dec26eb7fd347590fbced3ab38af52e.js'>
    </script>
    <script src="{% static 'userpage/friends.js' %}"></script>
</body>

</html>