{% extends 'categories/base.html' %}
{% load webpush_notifications %}
{% load static %}
{% load crispy_forms_tags %}
{% block title %} {{user.username}} | Dfreemedia {% endblock title %}

{% block description %}{{user.bio}}{% endblock description %}
{% block content %}
<img src="{{user.avatar.url}}" class="col-xl-2 col-lg-2 {% if user.id <= 1000 %}oldUser{% endif %}" alt="" width="200"
    height="200" style="max-width:200px; max-height:200px;">
<link rel="stylesheet" href="{% static 'userpage/index.css' %}">
<button type="button" class="btn btn-outline-secondary float-right mr-5 mt-4" data-toggle="modal"
    data-target="#editProfile" data-whatever="editProfile"><i class="fas fa-edit"></i></button>
<span class="ml-5">
    {% webpush_button with_class="btn btn-outline-info" %}
</span>
<br>

<ul class="list-group list-group-horizontal row justify-content-center mb-5 mt-5">
    <li class="list-group-item userMenuItem active">Home</li>
    <li class="list-group-item userMenuItem">Friends {{user.friends.count}}</li>
    <li class="list-group-item userMenuItem">Requests {{total_requests}}</li>
    <li class="list-group-item userMenuItem">My Requests</li>
</ul>
<div id="mainContainer">
    <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#privacy" data-whatever="privacy"><i
            class="fas fa-unlock"></i>Privacy</button>
    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#distractionFree"
        data-whatever="distractionFree">Distraction Free</button>
</div>
<div class="modal fade " id="editProfile" tabindex="-1" role="dialog" aria-labelledby="editProfileLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Edit {{user.username}} Profile</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="id_username">Username</label>
                        <input type="text" class="form-control" name="username" id="id_username" maxlength=30
                            value="{{ user.username }}">
                    </div>
                    <div class="form-group">
                        <label for="id_first_name">First Name</label>
                        <input type="text" class="form-control" name="first_name" id="id_first_name" maxlength=30
                            value="{{ user.first_name }}">
                    </div>
                    <div class="form-group">
                        <label for="id_last_name">Last Name</label>
                        <input type="text" class="form-control" name="last_name" id="id_last_name" maxlength=30
                            value="{{ user.last_name }}">
                    </div>
                    <!-- <div class="form-group">
                        <label for="id_email">Email</label>
                        <input type="text" class="form-control" name="email" id="id_email" value="{{ user.email }}">
                    </div> -->
                    <div class="form-group">
                        <label for="id_bio">Bio</label>
                        <input type="text" class="form-control" name="bio" id="id_bio" value="{{ user.bio }}">
                    </div>
                    <div class="form-group">
                        <p><label for="id_avatar">Avatar:</label>
                            <input type="file" name="avatar" accept="image/*" id="id_avatar"></p>
                        <!-- <label for="id_avatar_clear">Clear Avatar</label>
                        <input type="checkbox" name="avatar-clear" id="id_avatar_clear"> -->
                    </div>
                    <div class="from-group">
                        <a href="{% url 'password_reset' %}" target="_blank">Reset Password</a>
                    </div>

                    <input type="submit" value="Update" class="btn btn-success" name="submit">
                    <br>
                    <hr>
                </form>
            </div>
        </div>
    </div>
</div>





<div class="modal fade " id="privacy" tabindex="-1" role="dialog" aria-labelledby="privacyLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Privacy</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{privacy_form|crispy}}
                    <input type="submit" value="Update Privacy" class="btn btn-success" name="submit">
                </form>
            </div>
        </div>
    </div>
</div>



<div class="modal fade " id="distractionFree" tabindex="-1" role="dialog" aria-labelledby="distractionFreeLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Distration Free</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="" name="distractionFree" method="post">
                    {% csrf_token %}

                    <div class="btn-group dropright">
                        <button type="button" class="btn btn dropdown-toggle" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            Notifications
                        </button>
                        <div class="dropdown-menu" id="notificationFields"
                            style="width: 250px; max-height:200px; overflow:scroll; ">
                        </div>
                    </div>
                    <br>
                    <br>
                    {% for field in distraction_free_form %}
                    {% if field.html_name == 'hide_posts_in_homepage' %}
                    {{field.label|safe}}
                    {{field}}
                    <hr>
                    <br>
                    {% elif field.html_name == 'allow_important_friend_messages' or field.html_name == 'allow_important_group_message' or field.html_name == 'allow_normal_friend_message' or field.html_name == 'allow_normal_group_message' or field.html_name == 'allow_comment_message' or field.html_name == 'allow_reply_message' or field.html_name == 'allow_invites' or field.html_name == 'your_invites' %}
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            window.addEventListener('load', function () {
                                $('#notificationFields').append(`
                            {{field.label|safe}}
                            {{field}}
                            <br>
                            `)
                            })
                        })
                    </script>
                    {% else %}
                    {{field.label|safe}}
                    {{field}}
                    <br>
                    <br>
                    {% endif %}
                    {% endfor %}
                    <input type="submit" name="submit" value="Dfree" class="btn btn-success" id="submitDFree"
                        style="display: none;">
                </form>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        window.addEventListener('load', function () {
                            $('#notificationFields').click(function (event) {
                                event.stopPropagation();
                            })
                        })
                    })
                </script>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="$('#submitDFree').click()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'userpage/index.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        window.addEventListener('load', function () {
            $('.userMenuItem').click(function (e) {
                e.preventDefault();
                $('.userMenuItem').removeClass('active');
                $(this).addClass('active');
                if ($(this).html() == 'Home') {
                    $('#mainContainer').html(`
        <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#privacy" data-whatever="privacy"><i
            class="fas fa-unlock"></i>Privacy</button>
    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#distractionFree"
        data-whatever="distractionFree">Distraction Free</button>
        `)
                } else if ($(this).html().includes('Friends')) {
                    $('#mainContainer').html(`
            <div class="card card-default" id="card_contacts">
    <div id="contacts" class="panel-collapse collapse show" aria-expanded="true">
        <ul class="list-group pull-down" id="contact-list">
            {% for friend in user.friends.all %}
            <li class="list-group-item">
                <div class="row w-100">
                    <div class="col-12 col-sm-6 col-md-3 px-0">
                        <a href="{% url 'people:people' friend.id %}">
                            {% if friend.who_see_avatar == 'everyone' or friend.who_see_avatar == 'friends' %}
                            <img src="{{ friend.avatar.url }}" alt="{{ friend.username }}"
                                class="img-fluid rounded-circle d-block mx-auto {% if user.id <= 1000 %}oldUser{% endif %}" height="73" width="73">
                            {% else %}
                            <img src="/media/profile_images/DefaultUserImage.jpg" alt="{{ friend.username }}"
                                class="img-fluid rounded-circle d-block mx-auto" height="73" width="73">
                            {% endif %}
                        </a>
                    </div>

                    <div class="col-12 col-sm-6 col-md-9 text-center text-sm-left">
                        <a href="{% url 'people:people' friend.id %}">
                            <label class="name lead">{{ friend.username }}</label>
                        </a>
                        <br>

                        {% if friend.phone %}
                        <span class="fa fa-fw fa-phone fa-fw text-muted" data-toggle="tooltip" title="Phone Number"
                            data-original-title="{{ friend.phone }}"></span>
                        <span class="text-muted small">{{ friend.phone }}</span>
                        <br>
                        {% endif %}
                        {% if friend.email and friend.show_email == True %}
                        <span class="fa fa-fw fa-envelope fa-fw text-muted" data-toggle="tooltip" title="Email"
                            data-original-title="{{ friend.email }}"></span>
                        <span class="text-muted small text-truncate">{{ friend.email }}</span>
                        <br>
                        {% endif %}
                        <span class="small text-truncate">{{ friend.bio }}</span>

                        <button type="button" class="btn btn-danger float-right unfriend" data-username="{{friend.username}}" data-pk="{{friend.id}}">UnFriend</button>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
            `)

                    $('.unfriend').click(function (e) {
                        e.preventDefault();
                        let confirmation = confirm(
                            'Are you sure you want to unfriend ' + $(
                                this)
                            .attr('data-username') + '')
                        if (confirmation) {
                            let friendUsername = $(this).attr('data-username') + ''
                            let thisButton = $(this)
                            $.ajax({
                                url: "{% url 'userpage:unfriend' %}",
                                data: {
                                    'pk': $(this).attr('data-pk')
                                },
                                method: 'get',
                                dataType: 'json',
                                success: function (response) {
                                    thisButton.parent().parent().fadeOut()
                                    $('#message_area').html(
                                        `<div class="alert alert-success"> You unfriended ${friendUsername}`
                                    )
                                }
                            })
                        }
                    });
                } else if ($(this).html().includes('Followers')) {
                    $('#mainContainer').html("Followers")
                } else if ($(this).html().includes('Requests')) {
                    $('#mainContainer').html(`
                <small class="from-text text-muted float-right mr-3"><a href="{% url 'people:all_people' %}">Find Friend</a></small>
<h1>Friends Requests</h1>
<p>{{requests.count}} Friend Request{{requests.count|pluralize}}</p>
<br>

{% for request in requests %}
<div class="media" id="{{request.id}}Friend">

    {% if request.from_user.who_see_avatar == 'everyone' %}
    <img src="{{ request.from_user.avatar.url }}" class="mr-3 {% if user.id <= 1000 %}oldUser{% endif %}" alt="{{ request.from_user.username }}" width="64"
        height="64">
    {% else %}
    <img src="/media/profile_images/DefaultUserImage.jpg" class="mr-3" alt="{{ request.from_user.username }}" width="64"
        height="64">
    {% endif %}

    <div class="media-body">
        <h5 class="mt-0"><a href="{% url 'people:people' request.from_user.id %}">{{ request.from_user }}</a> sent you a
            friend request <small class="form-text text-muted">
                {{request.date|date:"j b o"}}</small></small></h5>

    </div>
    <form method="GET" class="float-left ml-4 acceptFriendForm">
        {% csrf_token %}
        <input type="submit" value="Accept" name="acceptrequest," class="btn btn-success ml-2 acceptFriend" data-pk="{{request.id}}" data-username="{{ request.from_user.username }}">
    </form>
    <a class="btn btn-danger denyRequest" style="color: white;" data-pk="{{request.id}}">Deny</a>
    </div>
{% endfor %}
<hr>
<h1>Group Requests</h1>
<p>{{group_requests.count}} Group Request{{group_requests.count|pluralize}}</p>
<br>
{% for request in group_requests %}
<div class="media" id="{{request.id}}Group">
    {% if request.request_sender.who_see_avatar == 'everyone' %}
    <img src="{{ request.request_sender.avatar.url }}" class="mr-3 {% if user.id <= 1000 %}oldUser{% endif %}" alt="{{ request.request_sender.username }}"
        width="64" height="64">
    {% elif request.request_sender.who_see_avatar == 'friends' and request.request_sender in user_friends %}
    <img src="{{ request.request_sender.avatar.url }}" class="mr-3 {% if user.id <= 1000 %}oldUser{% endif %}" alt="{{ request.request_sender.username }}"
        width="64" height="64">
    {% else %}
    <img src="/media/profile_images/DefaultUserImage.jpg" class="mr-3" alt="{{ request.request_sender.username }}"
        width="64" height="64">
    {% endif %}

    <div class="media-body">
        <h5 class="mt-0">{{ request.request_sender }} wants you to join {{request.group.title}} <small
                class="form-text text-muted">
                {{request.date|date:"j b o"}}</small></small></h5>

    </div>
    <a class="btn btn-danger float-left denyGroup" href="{% url 'social:deny_group' %}" data-pk="{{ request.id }}">Deny</a>
    <form method="GET" class="AcceptGroup" data-pk = '{{request.id}}'>
        <input type="submit" value="Join" name="joingroup," class="btn btn-success ml-2" id="joinGroup{{request.id}}">
    </form>
</div>
{% endfor %}
                `)

                    function RequestHandler() {
                        // ACCEPT 
                        $('.acceptFriendForm').submit(function (event) {
                            let thisElement = $(this)
                            event.preventDefault()
                            event.preventDefault();
                            $.ajax({
                                type: "get",
                                url: "{% url 'userpage:acceptrequest' %}",
                                data: {
                                    'pk': $('.acceptFriend').attr('data-pk')
                                },
                                dataType: "json",
                                success: function (data) {
                                    thisElement.parent().fadeOut()
                                    $('#message_area').html('')
                                    $('#message_area').html(
                                        `<div class="alert alert-success">${thisElement.attr('data-username')} is now a friend</div>`
                                    )
                                }
                            });
                        });
                        // DENNY
                        $('.denyRequest').click(function (event) {
                            event.preventDefault();
                            let thisElement = $(this);
                            $.ajax({
                                method: "get",
                                url: "{% url 'userpage:denyrequest' %}",
                                data: {
                                    'pk': $(this).attr('data-pk')
                                },
                                dataType: "json",
                                success: function (data) {
                                    $('#message_area').html('')
                                    thisElement.parent().fadeOut();
                                    if (data.message.tags === 'error') {
                                        $('#message_area').append(`
                            <div class="alert alert-danger fixed-top">${data.message.text}</div>
                            `)
                                    } else {
                                        $('#message_area').append(`
        <div class="alert alert-${data.message.tags} fixed-top">${data.message.text}</div>
                                `)
                                    }
                                }
                            });

                        })

                        // ACCEPT INVITE
                        $('.AcceptGroup').submit(function (event) {
                            let thisElement = $(this)
                            event.preventDefault()
                            $.ajax({
                                url: "{% url 'social:join_group' %}",
                                data: {
                                    'pk': $(this).attr('data-pk'),
                                },
                                dataType: 'json',
                                success: function (data) {
                                    thisElement.parent().fadeOut()
                                    $('#message_area').html('')
                                    if (data.message.tags === 'error') {
                                        $('#message_area').append(`
                            <div class="alert alert-danger fixed-top">${data.message.text}</div>
                            `)
                                    } else {
                                        $('#message_area').append(`
        <div class="alert alert-${data.message.tags} fixed-top">${data.message.text}</div>
                                `)
                                    }
                                    setTimeout(() => {
                                        $('#{{request.id}}Group')
                                            .fadeOut()
                                    }, 900);
                                    setTimeout(() => {
                                        $('#message_area').fadeOut()
                                    }, 3200);
                                }

                            })
                        })
                        // DENY INVITE
                        $('.denyGroup').click(function (event) {
                            let thisElement = $(this)
                            event.preventDefault();
                            $.ajax({
                                type: "get",
                                url: "{% url 'social:deny_group' %}",
                                data: {
                                    'pk': $(this).attr('data-pk')
                                },
                                dataType: "json",
                                success: function (data) {
                                    thisElement.parent().fadeOut()
                                    $('#message_area').html('')
                                    if (data.message.tags === 'error') {
                                        $('#message_area').append(`
                            <div class="alert alert-danger fixed-top">${data.message.text}</div>
                            `)
                                    } else {
                                        $('#message_area').append(`
        <div class="alert alert-${data.message.tags} fixed-top">${data.message.text}</div>
                                `)
                                    }
                                    setTimeout(() => {
                                        $('#{{request.id}}Group')
                                            .fadeOut()
                                    }, 900);
                                    setTimeout(() => {
                                        $('#message_area').fadeOut()
                                    }, 3200);
                                },
                            });
                        });

                    }
                    var g = document.createElement('script')
                    var s = document.getElementsByTagName('script')[0]
                    g.text(RequestHandler())
                    s.parentNode.insertBefore(g, s)
                } else if ($(this).html().includes('My Requests')) {
                    $('#mainContainer').html("Myyyy Requests")
                }
            });
        });
    });
</script>

{% endblock content %}